<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques - Bot Trading Hyperliquid</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .profit-positive {
            color: #28a745;
        }
        
        .profit-negative {
            color: #dc3545;
        }
        
        .chart-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
        }
        
        .chart-title-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .filter-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-label {
            font-weight: 600;
            color: #666;
        }
        
        .filter-select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-select:hover {
            border-color: #764ba2;
        }
        
        .market-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .market-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 5px solid;
        }
        
        .market-card.bull {
            border-left-color: #28a745;
        }
        
        .market-card.bear {
            border-left-color: #dc3545;
        }
        
        .market-card.range {
            border-left-color: #ffc107;
        }
        
        .market-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .market-icon {
            margin-right: 10px;
            font-size: 1.3em;
        }
        
        .market-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .market-stat:last-child {
            border-bottom: none;
        }
        
        .trade-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .trade-history-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .trade-history-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .trade-history-table tr:hover {
            background: #f8f9fa;
        }
        
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .period-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #667eea;
        }
        
        .period-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .period-btn.active {
            background: #667eea;
            color: white;
        }
        
        .performance-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .performance-excellent {
            background: #d4edda;
            color: #155724;
        }
        
        .performance-good {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .performance-average {
            background: #fff3cd;
            color: #856404;
        }
        
        .performance-poor {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">üìä Bot Trading Hyperliquid</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">üè† Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="statistics.html" class="nav-link active">üìà Statistiques</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Filtres de p√©riode -->
        <div class="filter-section">
            <span class="filter-label">üìÖ P√©riode:</span>
            <div class="period-selector">
                <button class="period-btn active" data-period="7">7 jours</button>
                <button class="period-btn" data-period="30">30 jours</button>
                <button class="period-btn" data-period="90">90 jours</button>
                <button class="period-btn" data-period="all">Tout</button>
            </div>
            <button class="btn btn-reload" onclick="refreshStats()" style="margin-left: auto; flex: 0;">
                üîÑ Actualiser
            </button>
        </div>

        <!-- Statistiques principales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-number profit-positive" id="totalProfit">+$0.00</div>
                <div class="stat-label">Profit Total</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üî¢</div>
                <div class="stat-number" id="totalTrades">0</div>
                <div class="stat-label">Trades Compl√©t√©s</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number" id="winRate">0%</div>
                <div class="stat-label">Taux de R√©ussite</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-number" id="avgProfit">$0.00</div>
                <div class="stat-label">Profit Moyen</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-number" id="bestTrade">$0.00</div>
                <div class="stat-label">Meilleur Trade</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìâ</div>
                <div class="stat-number" id="worstTrade">$0.00</div>
                <div class="stat-label">Pire Trade</div>
            </div>
        </div>

        <!-- Graphique de profit cumul√© -->
        <div class="chart-section">
            <h2 class="chart-title">
                <span class="chart-title-icon">üìà</span>
                √âvolution du Profit Cumul√©
            </h2>
            <canvas id="profitChart" height="80"></canvas>
        </div>

        <!-- R√©partition par type de march√© -->
        <div class="chart-section">
            <h2 class="chart-title">
                <span class="chart-title-icon">üéØ</span>
                Performance par Type de March√©
            </h2>
            <div class="market-breakdown">
                <div class="market-card bull">
                    <div class="market-title">
                        <span class="market-icon">üêÇ</span>
                        BULL
                    </div>
                    <div class="market-stat">
                        <span>Trades:</span>
                        <strong id="bullTrades">0</strong>
                    </div>
                    <div class="market-stat">
                        <span>Profit:</span>
                        <strong class="profit-positive" id="bullProfit">$0.00</strong>
                    </div>
                    <div class="market-stat">
                        <span>Taux r√©ussite:</span>
                        <strong id="bullWinRate">0%</strong>
                    </div>
                    <div class="market-stat">
                        <span>Avg profit:</span>
                        <strong id="bullAvgProfit">$0.00</strong>
                    </div>
                </div>

                <div class="market-card bear">
                    <div class="market-title">
                        <span class="market-icon">üêª</span>
                        BEAR
                    </div>
                    <div class="market-stat">
                        <span>Trades:</span>
                        <strong id="bearTrades">0</strong>
                    </div>
                    <div class="market-stat">
                        <span>Profit:</span>
                        <strong class="profit-positive" id="bearProfit">$0.00</strong>
                    </div>
                    <div class="market-stat">
                        <span>Taux r√©ussite:</span>
                        <strong id="bearWinRate">0%</strong>
                    </div>
                    <div class="market-stat">
                        <span>Avg profit:</span>
                        <strong id="bearAvgProfit">$0.00</strong>
                    </div>
                </div>

                <div class="market-card range">
                    <div class="market-title">
                        <span class="market-icon">‚ÜîÔ∏è</span>
                        RANGE
                    </div>
                    <div class="market-stat">
                        <span>Trades:</span>
                        <strong id="rangeTrades">0</strong>
                    </div>
                    <div class="market-stat">
                        <span>Profit:</span>
                        <strong class="profit-positive" id="rangeProfit">$0.00</strong>
                    </div>
                    <div class="market-stat">
                        <span>Taux r√©ussite:</span>
                        <strong id="rangeWinRate">0%</strong>
                    </div>
                    <div class="market-stat">
                        <span>Avg profit:</span>
                        <strong id="rangeAvgProfit">$0.00</strong>
                    </div>
                </div>
            </div>

            <!-- Graphique en camembert -->
            <div style="max-width: 500px; margin: 30px auto;">
                <canvas id="marketPieChart"></canvas>
            </div>
        </div>

        <!-- Graphique distribution des profits -->
        <div class="chart-section">
            <h2 class="chart-title">
                <span class="chart-title-icon">üìä</span>
                Distribution des Profits/Pertes
            </h2>
            <canvas id="distributionChart" height="80"></canvas>
        </div>

        <!-- Historique des derniers trades -->
        <div class="chart-section">
            <h2 class="chart-title">
                <span class="chart-title-icon">üìú</span>
                Historique des 20 Derniers Trades
            </h2>
            <div class="table-container">
                <table class="trade-history-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>March√©</th>
                            <th>Prix Achat</th>
                            <th>Prix Vente</th>
                            <th>Quantit√© BTC</th>
                            <th>Profit/Perte</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="tradeHistoryBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Chargement des donn√©es...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Indicateurs de performance -->
        <div class="chart-section">
            <h2 class="chart-title">
                <span class="chart-title-icon">üéØ</span>
                Indicateurs de Performance
            </h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Sharpe Ratio</div>
                    <div class="stat-number" id="sharpeRatio">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max Drawdown</div>
                    <div class="stat-number profit-negative" id="maxDrawdown">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Profit Factor</div>
                    <div class="stat-number" id="profitFactor">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Holding Time</div>
                    <div class="stat-number" id="avgHoldingTime">0h</div>
                </div>
            </div>
        </div>

        <div class="refresh-info">
            ‚è∞ Derni√®re mise √† jour: <span id="lastUpdate">-</span> | 
            Auto-refresh: 30 secondes
        </div>
    </div>

    <script>
        let profitChart, marketPieChart, distributionChart;
        let currentPeriod = 7; // P√©riode par d√©faut: 7 jours

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadStatistics();
            setupPeriodButtons();
            
            // Auto-refresh toutes les 30 secondes
            setInterval(loadStatistics, 30000);
        });

        // Configuration des boutons de p√©riode
        function setupPeriodButtons() {
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.dataset.period;
                    loadStatistics();
                });
            });
        }

        // Initialisation des graphiques
        function initCharts() {
            // Graphique profit cumul√©
            const profitCtx = document.getElementById('profitChart').getContext('2d');
            profitChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Profit Cumul√© ($)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            // Graphique camembert par march√©
            const pieCtx = document.getElementById('marketPieChart').getContext('2d');
            marketPieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['BULL', 'BEAR', 'RANGE'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'R√©partition des Trades par March√©'
                        }
                    }
                }
            });

            // Graphique distribution
            const distCtx = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(distCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Profit/Perte ($)',
                        data: [],
                        backgroundColor: [],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Chargement des statistiques
        async function loadStatistics() {
            try {
                // Appel API pour r√©cup√©rer les statistiques
                const response = await fetch(`/api/statistics?period=${currentPeriod}`);
                const data = await response.json();

                if (data.success) {
                    updateMainStats(data.stats);
                    updateMarketBreakdown(data.market_breakdown);
                    updateCharts(data);
                    updateTradeHistory(data.recent_trades);
                    updatePerformanceIndicators(data.performance);
                    
                    // Mise √† jour de l'heure
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('fr-FR');
                }
            } catch (error) {
                console.error('Erreur chargement statistiques:', error);
                // Charger des donn√©es de d√©monstration en cas d'erreur
                loadDemoData();
            }
        }

        // Mise √† jour des stats principales
        function updateMainStats(stats) {
            const profit = stats.total_profit || 0;
            document.getElementById('totalProfit').textContent = formatCurrency(profit);
            document.getElementById('totalProfit').className = profit >= 0 ? 'stat-number profit-positive' : 'stat-number profit-negative';
            
            document.getElementById('totalTrades').textContent = stats.total_trades || 0;
            document.getElementById('winRate').textContent = (stats.win_rate || 0).toFixed(1) + '%';
            document.getElementById('avgProfit').textContent = formatCurrency(stats.avg_profit || 0);
            document.getElementById('bestTrade').textContent = formatCurrency(stats.best_trade || 0);
            document.getElementById('worstTrade').textContent = formatCurrency(stats.worst_trade || 0);
        }

        // Mise √† jour par march√©
        function updateMarketBreakdown(breakdown) {
            ['bull', 'bear', 'range'].forEach(market => {
                const data = breakdown[market] || {};
                document.getElementById(`${market}Trades`).textContent = data.trades || 0;
                document.getElementById(`${market}Profit`).textContent = formatCurrency(data.profit || 0);
                document.getElementById(`${market}WinRate`).textContent = (data.win_rate || 0).toFixed(1) + '%';
                document.getElementById(`${market}AvgProfit`).textContent = formatCurrency(data.avg_profit || 0);
                
                // Couleur du profit
                const profitEl = document.getElementById(`${market}Profit`);
                profitEl.className = (data.profit || 0) >= 0 ? 'profit-positive' : 'profit-negative';
            });

            // Mise √† jour du camembert
            marketPieChart.data.datasets[0].data = [
                breakdown.bull?.trades || 0,
                breakdown.bear?.trades || 0,
                breakdown.range?.trades || 0
            ];
            marketPieChart.update();
        }

        // Mise √† jour des graphiques
        function updateCharts(data) {
            // Graphique profit cumul√©
            if (data.cumulative_profit) {
                profitChart.data.labels = data.cumulative_profit.dates;
                profitChart.data.datasets[0].data = data.cumulative_profit.values;
                profitChart.update();
            }

            // Graphique distribution
            if (data.distribution) {
                distributionChart.data.labels = data.distribution.labels;
                distributionChart.data.datasets[0].data = data.distribution.values;
                distributionChart.data.datasets[0].backgroundColor = data.distribution.values.map(v => 
                    v >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
                );
                distributionChart.update();
            }
        }

        // Mise √† jour de l'historique
        function updateTradeHistory(trades) {
            const tbody = document.getElementById('tradeHistoryBody');
            
            if (!trades || trades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            üì≠ Aucun trade compl√©t√© pour le moment
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = trades.map(trade => {
                const profitClass = trade.profit >= 0 ? 'profit' : 'loss';
                const perfClass = getPerformanceClass(trade.profit_percent);
                const perfLabel = getPerformanceLabel(trade.profit_percent);
                
                return `
                    <tr>
                        <td>${trade.index}</td>
                        <td>${new Date(trade.completed_at).toLocaleDateString('fr-FR')}</td>
                        <td><strong>${trade.market_type}</strong></td>
                        <td>$${trade.buy_price.toFixed(2)}</td>
                        <td>$${trade.sell_price.toFixed(2)}</td>
                        <td>${trade.quantity_btc.toFixed(8)} BTC</td>
                        <td class="${profitClass}"><strong>${formatCurrency(trade.profit)}</strong></td>
                        <td>
                            <span class="performance-indicator ${perfClass}">
                                ${perfLabel}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Mise √† jour des indicateurs de performance
        function updatePerformanceIndicators(perf) {
            document.getElementById('sharpeRatio').textContent = (perf?.sharpe_ratio || 0).toFixed(2);
            document.getElementById('maxDrawdown').textContent = (perf?.max_drawdown || 0).toFixed(1) + '%';
            document.getElementById('profitFactor').textContent = (perf?.profit_factor || 0).toFixed(2);
            document.getElementById('avgHoldingTime').textContent = (perf?.avg_holding_time || 0).toFixed(1) + 'h';
        }

        // Fonctions utilitaires
        function formatCurrency(value) {
            const sign = value >= 0 ? '+' : '';
            return sign + '$' + Math.abs(value).toFixed(2);
        }

        function getPerformanceClass(percent) {
            if (percent >= 2) return 'performance-excellent';
            if (percent >= 0.5) return 'performance-good';
            if (percent >= 0) return 'performance-average';
            return 'performance-poor';
        }

        function getPerformanceLabel(percent) {
            if (percent >= 2) return `Excellent (+${percent.toFixed(2)}%)`;
            if (percent >= 0.5) return `Bon (+${percent.toFixed(2)}%)`;
            if (percent >= 0) return `Moyen (+${percent.toFixed(2)}%)`;
            return `Perte (${percent.toFixed(2)}%)`;
        }

        function refreshStats() {
            loadStatistics();
        }

        // Donn√©es de d√©monstration (si l'API n'est pas disponible)
        function loadDemoData() {
            const demoStats = {
                total_profit: 1234.56,
                total_trades: 45,
                win_rate: 68.9,
                avg_profit: 27.43,
                best_trade: 125.50,
                worst_trade: -45.20
            };

            const demoMarketBreakdown = {
                bull: { trades: 20, profit: 856.32, win_rate: 75.0, avg_profit: 42.82 },
                bear: { trades: 10, profit: 234.12, win_rate: 60.0, avg_profit: 23.41 },
                range: { trades: 15, profit: 144.12, win_rate: 66.7, avg_profit: 9.61 }
            };

            const demoCumulativeProfit = {
                dates: ['01/12', '02/12', '03/12', '04/12', '05/12', '06/12', '07/12'],
                values: [0, 150, 320, 280, 560, 890, 1234.56]
            };

            const demoDistribution = {
                labels: Array.from({length: 20}, (_, i) => `T${i+1}`),
                values: [45.2, -12.3, 67.8, 23.4, -8.9, 89.1, 34.5, -15.2, 56.7, 12.3, 
                        78.9, -20.1, 45.6, 90.2, -5.4, 34.5, 67.8, 23.1, -18.9, 56.4]
            };

            const demoTrades = Array.from({length: 10}, (_, i) => ({
                index: i + 1,
                completed_at: new Date(Date.now() - i * 86400000).toISOString(),
                market_type: ['BULL', 'BEAR', 'RANGE'][Math.floor(Math.random() * 3)],
                buy_price: 95000 + Math.random() * 5000,
                sell_price: 95500 + Math.random() * 5000,
                quantity_btc: 0.001 + Math.random() * 0.002,
                profit: -50 + Math.random() * 150,
                profit_percent: -1 + Math.random() * 4
            }));

            const demoPerformance = {
                sharpe_ratio: 1.85,
                max_drawdown: -8.5,
                profit_factor: 2.34,
                avg_holding_time: 4.5
            };

            updateMainStats(demoStats);
            updateMarketBreakdown(demoMarketBreakdown);
            updateCharts({
                cumulative_profit: demoCumulativeProfit,
                distribution: demoDistribution
            });
            updateTradeHistory(demoTrades);
            updatePerformanceIndicators(demoPerformance);

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('fr-FR') + ' (DEMO)';
        }
    </script>
</body>
</html>
